const TelegramBot = require('node-telegram-bot-api');
const axios = require('axios');
const pool = require('./db');


const token = '7597057776:AAEWjSDt51rng3We7CljUfW3aWP119ke9TQ';
const bot = new TelegramBot(token, { polling: true });

const userState = {};

const mostrarMenuPrincipal = (chatId) => {
  userState[chatId] = { etapa: 'menu' };
  bot.sendMessage(chatId, 'üìã Men√∫ principal:', {
    reply_markup: {
      keyboard: [
        ['üõí Realizar pedido'],
        ['‚úèÔ∏è Modificar pedido', 'üóëÔ∏è Eliminar pedido'],
        ['üì¶ Revisar stock', 'üëï Ver productos'],
        ['üìã Ver pedidos'],
        ['‚ùå Cancelar']
      ],
      resize_keyboard: true
    }
  });
};

bot.onText(/\/start/i, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, `üëã ¬°Hola ${msg.from.first_name}! Bienvenido a tu asistente de ventas. Elige la opci√≥n que desees realizar.`)
    .then(() => {
      mostrarMenuPrincipal(chatId);
    });
  return;
});

bot.on('message', async (msg) => {
  const chatId = msg.chat.id;
  const texto = msg.text?.toLowerCase();
  if (texto.startsWith('/start')) return;
  if (texto.includes('cancelar')) {
    userState[chatId] = { etapa: 'cancelado' };
    return bot.sendMessage(chatId, '‚ùå Operaci√≥n cancelada. ¬øQuer√©s volver al men√∫ principal?', {
      reply_markup: {
        keyboard: [['S√≠', 'No']],
        resize_keyboard: true
      }
    });
  }

  if (texto === 's√≠' && userState[chatId]?.etapa === 'cancelado') {
    return mostrarMenuPrincipal(chatId);
  }

  if (texto === 'no' && userState[chatId]?.etapa === 'cancelado') {
    userState[chatId] = {};
    return bot.sendMessage(chatId, 'üëç Entendido. Pod√©s usar /start cuando quieras volver al men√∫.');
  }

  const estado = userState[chatId] || {};

  if (!estado.etapa || estado.etapa === 'menu') {
    if (texto === 'üõí realizar pedido') {
      userState[chatId] = { etapa: 'esperando_prenda' };
      return bot.sendMessage(chatId, '¬øQu√© tipo de prenda quer√©s?', {
        reply_markup: {
          keyboard: [
            ['Camiseta', 'Falda', 'Sudadera'],
            ['Chaqueta', 'Pantal√≥n', 'Camisa'],
            ['‚ùå Cancelar']
          ],
          resize_keyboard: true
        }
      });
    }

    if (texto === '‚úèÔ∏è modificar pedido') {
      userState[chatId] = { etapa: 'esperando_id_modificar' };
      return bot.sendMessage(chatId, '‚úèÔ∏è Ingres√° el ID del pedido que quer√©s modificar:', {
        reply_markup: {
          keyboard: [['‚ùå Cancelar']],
          resize_keyboard: true
        }
      });
    }

    if (texto === 'üóëÔ∏è eliminar pedido') {
      userState[chatId] = { etapa: 'esperando_id_eliminar' };
      return bot.sendMessage(chatId, 'üóëÔ∏è Ingres√° el ID del pedido que quer√©s eliminar:', {
        reply_markup: {
          keyboard: [['‚ùå Cancelar']]
        , resize_keyboard: true }
      });
    }

    if (texto === 'üìã ver pedidos') {
      try {
        const res = await axios.get('https://agente-ventas-telegram.onrender.com/pedidos');
        const pedidos = res.data;

        if (!pedidos.length) {
          return bot.sendMessage(chatId, 'üì≠ No hay pedidos registrados.');
        }

        const lista = pedidos
          .map(
            (p) =>
              `üßæ ID: ${p.id}\nüëï ${p.tipo_prenda} - ${p.color} - Talla ${p.talla}\nüì¶ Cantidad: ${p.cantidad}\nüïí Fecha: ${new Date(p.fecha).toLocaleString()}`
          )
          .join('\n\n');

        return bot.sendMessage(chatId, `üìã Lista de pedidos:\n\n${lista}`);
      } catch (err) {
        console.error(err);
        return bot.sendMessage(chatId, '‚ùå Error al obtener los pedidos.');
      }
    }

    if (texto === 'üì¶ revisar stock') {
      userState[chatId] = { etapa: 'stock_prenda' };
      return bot.sendMessage(chatId, 'üîé ¬øQu√© tipo de prenda quer√©s consultar?', {
        reply_markup: {
          keyboard: [
            ['Camiseta', 'Falda', 'Sudadera'],
            ['Chaqueta', 'Pantal√≥n', 'Camisa'],
            ['‚ùå Cancelar']
          ],
          resize_keyboard: true
        }
      });
    }

    if (texto === 'üëï ver productos') {
  userState[chatId] = { etapa: 'esperando_prenda_ver' };
  return bot.sendMessage(chatId, 'üëï Estas son nuestras prendas, eleg√≠ una para ver todos sus modelos:', {
    reply_markup: {
      keyboard: [
        ['Camiseta', 'Falda', 'Sudadera'],
        ['Chaqueta', 'Pantal√≥n', 'Camisa'],
        ['‚ùå Cancelar']
      ],
      resize_keyboard: true
            }
        });
    }

      return bot.sendMessage(chatId, '‚ö†Ô∏è Opci√≥n no reconocida. Eleg√≠ una de las opciones del men√∫:', {
    reply_markup: {
      keyboard: [
        ['üõí Realizar pedido'],
        ['‚úèÔ∏è Modificar pedido', 'üóëÔ∏è Eliminar pedido'],
        ['üì¶ Revisar stock', 'üëï Ver productos'],
        ['üìã Ver pedidos'],
        ['‚ùå Cancelar']
      ],
      resize_keyboard: true
    }
  });
  }

  if (estado.etapa === 'esperando_id_modificar') {
    const id = parseInt(texto);
    if (isNaN(id)) {
      return bot.sendMessage(chatId, '‚ö†Ô∏è Por favor ingres√° un n√∫mero de ID v√°lido o cancel√°.');
    }

    try {
      const res = await axios.get(`https://agente-ventas-telegram.onrender.com/pedidos/${id}`);
      const pedido = res.data;
      const fechaCreacion = new Date(pedido.fecha);
      const ahora = new Date();
      const minutos = (ahora - fechaCreacion) / 60000;

      if (minutos > 5) {
        userState[chatId] = {};
        bot.sendMessage(chatId, '‚è≥ Ya pasaron m√°s de 5 minutos desde que se cre√≥ este pedido, no se puede modificar.');
        return mostrarMenuPrincipal(chatId);
      }

      userState[chatId] = { etapa: 'modificar_prenda', id_modificar: id };
      return bot.sendMessage(chatId, '¬øQu√© tipo de prenda quer√©s establecer para este pedido?', {
        reply_markup: {
          keyboard: [
            ['Camiseta', 'Falda', 'Sudadera'],
            ['Chaqueta', 'Pantal√≥n', 'Camisa'],
            ['‚ùå Cancelar']
          ],
          resize_keyboard: true
        }
      });

    } catch (error) {
      console.error(error);
      userState[chatId] = {};
      await bot.sendMessage(chatId, '‚ùå No se encontr√≥ el pedido o hubo un error.');
      return mostrarMenuPrincipal(chatId);
    }
  }

  if (estado.etapa === 'modificar_prenda') {
  const opcionesValidas = ['camiseta', 'falda', 'sudadera', 'chaqueta', 'pantal√≥n', 'camisa'];
  if (!opcionesValidas.includes(texto)) {
    return bot.sendMessage(chatId, '‚ö†Ô∏è Opci√≥n no v√°lida. Por favor seleccion√° una prenda de las opciones disponibles.', {
      reply_markup: {
        keyboard: [
          ['Camiseta', 'Falda', 'Sudadera'],
          ['Chaqueta', 'Pantal√≥n', 'Camisa'],
          ['‚ùå Cancelar']
        ],
        resize_keyboard: true
      }
    });
  }
  userState[chatId] = { ...estado, etapa: 'modificar_talla', tipo_prenda: texto };
  return bot.sendMessage(chatId, '¬øQu√© talla quer√©s establecer?', {
    reply_markup: {
      keyboard: [['S', 'M', 'L'], ['XL', 'XXL'], ['‚ùå Cancelar']],
      resize_keyboard: true
    }
  });
}

  if (estado.etapa === 'modificar_talla') {
  const opcionesTalla = ['s', 'm', 'l', 'xl', 'xxl'];
  if (!opcionesTalla.includes(texto)) {
    return bot.sendMessage(chatId, '‚ö†Ô∏è Opci√≥n no v√°lida. Por favor seleccion√° una talla v√°lida de las opciones.', {
      reply_markup: {
        keyboard: [['S', 'M', 'L'], ['XL', 'XXL'], ['‚ùå Cancelar']],
        resize_keyboard: true
      }
    });
  }
  userState[chatId] = { ...estado, etapa: 'modificar_color', talla: texto };
  return bot.sendMessage(chatId, '¬øQu√© color prefer√≠s?', {
    reply_markup: {
      keyboard: [
        ['Verde', 'Blanco', 'Negro'],
        ['Amarillo', 'Gris', 'Azul', 'Rojo'],
        ['‚ùå Cancelar']
      ],
      resize_keyboard: true
    }
  });
}

  if (estado.etapa === 'modificar_color') {
  const opcionesColor = ['verde', 'blanco', 'negro', 'amarillo', 'gris', 'azul', 'rojo'];
  if (!opcionesColor.includes(texto)) {
    return bot.sendMessage(chatId, '‚ö†Ô∏è Opci√≥n no v√°lida. Por favor seleccion√° un color de las opciones.', {
      reply_markup: {
        keyboard: [
          ['Verde', 'Blanco', 'Negro'],
          ['Amarillo', 'Gris', 'Azul', 'Rojo'],
          ['‚ùå Cancelar']
        ],
        resize_keyboard: true
      }
    });
  }

  userState[chatId] = { ...estado, etapa: 'modificar_cantidad', color: texto };
  return bot.sendMessage(chatId, '¬øQu√© cantidad quer√©s establecer?', {
    reply_markup: {
      keyboard: [['‚ùå Cancelar']],
      resize_keyboard: true
    }
  });
}

  if (estado.etapa === 'modificar_cantidad') {
  const cantidad = parseInt(texto);
  if (isNaN(cantidad)) {
    return bot.sendMessage(chatId, '‚ö†Ô∏è Por favor ingres√° una cantidad v√°lida.');
  }

  const { tipo_prenda, talla, color, id_modificar } = estado;

  try {
    const check = await axios.post('https://agente-ventas-telegram.onrender.com/productos/search', {
      tipo_prenda,
      talla,
      color
    });

    const disponibles = check.data.filter(
      (p) => p.disponible.toLowerCase() === 'si'
    );

    if (!disponibles.length) {
      userState[chatId] = {};
      bot.sendMessage(
        chatId,
        `‚ùå El producto ya no est√° disponible para modificar el pedido.\nüëï ${tipo_prenda} - ${color} - ${talla}`
      );
      return mostrarMenuPrincipal(chatId);
    }

    const producto = disponibles[0];

    if (cantidad > producto.cantidad_disponible) {
      userState[chatId] = {};
      bot.sendMessage(
        chatId,
        `‚ö†Ô∏è Solo hay ${producto.cantidad_disponible} unidades disponibles.\nNo pod√©s modificar el pedido a ${cantidad} unidades.`
      );
      return mostrarMenuPrincipal(chatId);
    }

    const res = await axios.put(`https://agente-ventas-telegram.onrender.com/editar-pedido/${id_modificar}`, {
      tipo_prenda,
      talla,
      color,
      cantidad
    });

    userState[chatId] = {};
    bot.sendMessage(chatId, `‚úÖ Pedido actualizado correctamente:\nüßæ ID: ${res.data.id}\nüëï ${res.data.tipo_prenda} - ${res.data.color} - ${res.data.talla}\nüì¶ Cantidad: ${res.data.cantidad}`);
    return mostrarMenuPrincipal(chatId);
  } catch (error) {
    console.error(error);
    return bot.sendMessage(chatId, '‚ùå No se pudo modificar el pedido.');
  }
}

  if (estado.etapa === 'esperando_id_eliminar') {
    const id = parseInt(texto);
    if (isNaN(id)) {
      return bot.sendMessage(chatId, '‚ö†Ô∏è Por favor ingres√° un n√∫mero de ID v√°lido o cancel√°.');
    }

    try {
      const res = await axios.delete(`https://agente-ventas-telegram.onrender.com/pedidos/${id}`);
      userState[chatId] = {};
      bot.sendMessage(chatId, `‚úÖ Pedido con ID ${id} eliminado correctamente.`);
      return mostrarMenuPrincipal(chatId);
    } catch (err) {
      console.error(err);
      return bot.sendMessage(chatId, '‚ùå No se pudo eliminar el pedido. ¬øEst√°s seguro que el ID existe?');
    }
  }

 if (estado.etapa === 'esperando_prenda') {
  const opcionesValidas = ['camiseta', 'falda', 'sudadera', 'chaqueta', 'pantal√≥n', 'camisa'];
  if (!opcionesValidas.includes(texto)) {
    return bot.sendMessage(chatId, '‚ö†Ô∏è Opci√≥n no v√°lida. Por favor seleccion√° una prenda de las opciones disponibles.', {
      reply_markup: {
        keyboard: [
          ['Camiseta', 'Falda', 'Sudadera'],
          ['Chaqueta', 'Pantal√≥n', 'Camisa'],
          ['‚ùå Cancelar']
        ],
        resize_keyboard: true
      }
    });
  }
  userState[chatId] = { etapa: 'esperando_talla', tipo_prenda: texto };
  return bot.sendMessage(chatId, '¬øQu√© talla necesit√°s?', {
    reply_markup: {
      keyboard: [['S', 'M', 'L'], ['XL', 'XXL'], ['‚ùå Cancelar']],
      resize_keyboard: true
    }
  });
}

  if (estado.etapa === 'esperando_talla') {
  const opcionesTalla = ['s', 'm', 'l', 'xl', 'xxl'];
  if (!opcionesTalla.includes(texto)) {
    return bot.sendMessage(chatId, '‚ö†Ô∏è Opci√≥n no v√°lida. Por favor seleccion√° una talla v√°lida de las opciones.', {
      reply_markup: {
        keyboard: [['S', 'M', 'L'], ['XL', 'XXL'], ['‚ùå Cancelar']],
        resize_keyboard: true
      }
    });
  }
  userState[chatId] = { ...estado, etapa: 'esperando_color', talla: texto };
  return bot.sendMessage(chatId, '¬øQu√© color prefer√≠s?', {
    reply_markup: {
      keyboard: [
        ['Verde', 'Blanco', 'Negro'],
        ['Amarillo', 'Gris', 'Azul', 'Rojo'],
        ['‚ùå Cancelar']
      ],
      resize_keyboard: true
    }
  });
}

  if (estado.etapa === 'esperando_color') {
  const opcionesColor = ['verde', 'blanco', 'negro', 'amarillo', 'gris', 'azul', 'rojo'];
  if (!opcionesColor.includes(texto)) {
    return bot.sendMessage(chatId, '‚ö†Ô∏è Opci√≥n no v√°lida. Por favor seleccion√° un color de las opciones.', {
      reply_markup: {
        keyboard: [
          ['Verde', 'Blanco', 'Negro'],
          ['Amarillo', 'Gris', 'Azul', 'Rojo'],
          ['‚ùå Cancelar']
        ],
        resize_keyboard: true
      }
    });
  }
  userState[chatId] = { ...estado, etapa: 'esperando_cantidad', color: texto };
  return bot.sendMessage(chatId, '¬øQu√© cantidad quer√©s pedir?', {
    reply_markup: {
      keyboard: [['‚ùå Cancelar']],
      resize_keyboard: true
    }
  });
}

  if (estado.etapa === 'esperando_cantidad') {
  const cantidad = parseInt(texto);
  if (isNaN(cantidad)) {
    return bot.sendMessage(chatId, '‚ö†Ô∏è Por favor ingres√° un n√∫mero v√°lido o cancel√°.');
  }

  const { tipo_prenda, talla, color } = estado;

  try {
    const check = await axios.post('https://agente-ventas-telegram.onrender.com/productos/search', {
      tipo_prenda,
      talla,
      color
    });

    const disponibles = check.data.filter(
      (p) => p.disponible.toLowerCase() === 'si'
    );

    if (!disponibles.length) {
      userState[chatId] = {};
      bot.sendMessage(
        chatId,
        `‚ùå El producto seleccionado no est√° disponible en este momento.\n\nüëï ${tipo_prenda} - ${color} - Talla ${talla}`
      );
      return mostrarMenuPrincipal(chatId);
    }

    const producto = disponibles[0];

    if (cantidad > producto.cantidad_disponible) {
      userState[chatId] = {};
      bot.sendMessage(
        chatId,
        `‚ö†Ô∏è Solo hay ${producto.cantidad_disponible} unidades disponibles para este producto.\nNo se puede realizar el pedido por ${cantidad} unidades.`
      );
      return mostrarMenuPrincipal(chatId);
    }

    const response = await axios.post('https://agente-ventas-telegram.onrender.com/pedidos', {
      tipo_prenda,
      talla,
      color,
      cantidad
    });

    userState[chatId] = {};
    bot.sendMessage(
      chatId,
      `‚úÖ Pedido registrado con √©xito:\nüßæ ID: ${response.data.id}\nüëï ${tipo_prenda} - ${color} - ${talla}\nüì¶ Cantidad: ${cantidad}`
    );
    return mostrarMenuPrincipal(chatId);
  } catch (err) {
    console.error('Error en verificaci√≥n o registro:', err.message);
    return bot.sendMessage(chatId, '‚ùå Hubo un error al verificar disponibilidad o registrar el pedido.');
  }
}

  if (estado.etapa === 'esperando_prenda_stock') {
  try {
    const res = await axios.get(`https://agente-ventas-telegram.onrender.com/stock?tipo_prenda=${encodeURIComponent(texto)}`);
    if (!res.data.length) {
      return bot.sendMessage(chatId, '‚ùå No se encontr√≥ stock para esa prenda.');
    }

    const stock = res.data[0].cantidad_disponible;
    userState[chatId] = {};
    bot.sendMessage(chatId, `üì¶ Stock disponible para ${texto}: ${stock} unidades.`);
    return mostrarMenuPrincipal(chatId);
  } catch (error) {
    console.error(error);
    return bot.sendMessage(chatId, '‚ùå Error al consultar stock.');
  }
}

 if (estado.etapa === 'stock_prenda') {
  const opcionesPrenda = ['camiseta', 'falda', 'sudadera', 'chaqueta', 'pantal√≥n', 'camisa'];
  if (!opcionesPrenda.includes(texto)) {
    return bot.sendMessage(chatId, '‚ö†Ô∏è Opci√≥n no v√°lida. Por favor seleccion√° una prenda v√°lida.', {
      reply_markup: {
        keyboard: [
          ['Camiseta', 'Falda', 'Sudadera'],
          ['Chaqueta', 'Pantal√≥n', 'Camisa'],
          ['‚ùå Cancelar']
        ],
        resize_keyboard: true
      }
    });
  }

  userState[chatId] = { etapa: 'stock_talla', tipo_prenda: texto };
  return bot.sendMessage(chatId, 'üìè ¬øQu√© talla quer√©s consultar?', {
    reply_markup: {
      keyboard: [['S', 'M', 'L'], ['XL', 'XXL'], ['‚ùå Cancelar']],
      resize_keyboard: true
    }
  });
}

  if (estado.etapa === 'stock_talla') {
  const opcionesTalla = ['s', 'm', 'l', 'xl', 'xxl'];
  if (!opcionesTalla.includes(texto)) {
    return bot.sendMessage(chatId, '‚ö†Ô∏è Opci√≥n no v√°lida. Por favor seleccion√° una talla v√°lida.', {
      reply_markup: {
        keyboard: [['S', 'M', 'L'], ['XL', 'XXL'], ['‚ùå Cancelar']],
        resize_keyboard: true
      }
    });
  }

  userState[chatId] = { ...estado, etapa: 'stock_color', talla: texto };
  return bot.sendMessage(chatId, 'üé® ¬øQu√© color te interesa?', {
    reply_markup: {
      keyboard: [
        ['Verde', 'Blanco', 'Negro'],
        ['Amarillo', 'Gris', 'Azul', 'Rojo'],
        ['‚ùå Cancelar']
      ],
      resize_keyboard: true
    }
  });
}

  if (estado.etapa === 'stock_color') {
  const opcionesColor = ['verde', 'blanco', 'negro', 'amarillo', 'gris', 'azul', 'rojo'];
  if (!opcionesColor.includes(texto)) {
    return bot.sendMessage(chatId, '‚ö†Ô∏è Opci√≥n no v√°lida. Por favor seleccion√° un color de las opciones.', {
      reply_markup: {
        keyboard: [
          ['Verde', 'Blanco', 'Negro'],
          ['Amarillo', 'Gris', 'Azul', 'Rojo'],
          ['‚ùå Cancelar']
        ],
        resize_keyboard: true
      }
    });
  }

  const { tipo_prenda, talla } = estado;
  const color = texto;

  try {
    const res = await axios.get(`https://agente-ventas-telegram.onrender.com/stock?tipo_prenda=${encodeURIComponent(tipo_prenda)}&talla=${encodeURIComponent(talla)}&color=${encodeURIComponent(color)}`);

    if (!res.data.length) {
      return bot.sendMessage(chatId, '‚ùå No se encontr√≥ stock para esa combinaci√≥n.');
    }

    const stock = res.data[0].cantidad_disponible;
    userState[chatId] = {};
    bot.sendMessage(chatId, `üì¶ Stock disponible para ${tipo_prenda} ${color} talla ${talla}: ${stock} unidades.`);
    return mostrarMenuPrincipal(chatId);
  } catch (error) {
    console.error(error);
    return bot.sendMessage(chatId, '‚ùå Error al consultar stock.');
  }
}

  if (estado.etapa === 'esperando_prenda_ver') {
  const opcionesValidas = ['camiseta', 'falda', 'sudadera', 'chaqueta', 'pantal√≥n', 'camisa'];
  if (!opcionesValidas.includes(texto)) {
    return bot.sendMessage(chatId, '‚ö†Ô∏è Opci√≥n no v√°lida. Por favor seleccion√° una prenda v√°lida de las opciones.', {
      reply_markup: {
        keyboard: [
          ['Camiseta', 'Falda', 'Sudadera'],
          ['Chaqueta', 'Pantal√≥n', 'Camisa'],
          ['‚ùå Cancelar']
        ],
        resize_keyboard: true
      }
    });
  }

  try {
    const res = await axios.get(`https://agente-ventas-telegram.onrender.com/productos/filtrar?tipo_prenda=${encodeURIComponent(texto)}`);
    const productos = res.data;

    if (!productos.length) {
      return bot.sendMessage(chatId, '‚ùå No se encontraron productos para ese tipo de prenda.');
    }

    const ordenTalles = ['S', 'M', 'L', 'XL', 'XXL'];
    productos.sort((a, b) => ordenTalles.indexOf(a.talla) - ordenTalles.indexOf(b.talla));

    for (const p of productos) {
      await bot.sendMessage(chatId,
        `üëï Talla: ${p.talla}\nüé® Color: ${p.color}\nüí≤ Precio 50u: $${p.precio_50_u}\nüí≤ Precio 100u: $${p.precio_100_u}\nüí≤ Precio 200u: $${p.precio_200_u}\nüè∑Ô∏è Categor√≠a: ${p.categoria}\nüìù Descripci√≥n: ${p.descripcion}`
      );
    }

    userState[chatId] = {};
    return mostrarMenuPrincipal(chatId);
  } catch (err) {
    console.error(err);
    return bot.sendMessage(chatId, '‚ùå Error al obtener productos.');
  }
}

});
